<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEM TEMPAHAN BILIK KHAS</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; padding: 15px; background-color: var(--bg); font-size: 14px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header { text-align: center; margin-bottom: 15px; }
        .header img { width: 70px; }
        .info-minggu { background: #2563eb; color: white; padding: 10px; border-radius: 10px; text-align: center; font-weight: 800; margin-bottom: 10px; }
        .alert-nilam { background: #fff7ed; border: 1px solid #ffedd5; color: #9a3412; padding: 8px; border-radius: 8px; font-size: 0.7rem; text-align: center; margin-bottom: 15px; font-weight: 600; }
        label { display: block; margin-top: 12px; font-weight: 600; color: #64748b; font-size: 0.75rem; text-transform: uppercase; }
        select, input { width: 100%; padding: 12px; margin-top: 5px; border: 2px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        .slot-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .slot-card { background: #f8fafc; border: 2px solid #e2e8f0; padding: 10px; border-radius: 12px; cursor: pointer; transition: 0.2s; min-height: 85px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .slot-card.selected { border-color: var(--primary); background: #eff6ff; box-shadow: 0 0 0 1px var(--primary); }
        .slot-card.booked { background: #fee2e2 !important; border-color: #fecaca !important; cursor: not-allowed; opacity: 0.7; }
        .nilam-tag { font-size: 0.65rem; font-weight: 800; padding: 4px 6px; border-radius: 6px; margin-top: 6px; width: fit-content; text-align: center; line-height: 1.2; }
        .tag-bm { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .tag-bi { background: #fef9c3; color: #854d0e; border: 1px solid #fef08a; }
        .waktu-txt { font-weight: 800; color: #1e293b; }
        .masa-txt { font-size: 0.7rem; color: #64748b; margin-bottom: 2px; }
        button#btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; margin-top: 25px; font-weight: 700; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <img src="https://i.postimg.cc/xCnTTXwg/logo-sk-clifford-kuala-lipis.png">
        <h3 style="margin: 5px 0; color: #1e293b;">TEMPAHAN BILIK KHAS</h3>
    </div>

    <div id="infoBar" class="info-minggu">SILA PILIH TARIKH</div>
    <div class="alert-nilam">INFO: SLOT DENGAN LABEL NILAM ADALAH KHAS UNTUK KELAS TERSEBUT</div>

    <form id="bookingForm" onsubmit="hantar(event)">
        <label>NAMA GURU</label>
        <select id="nama" required>
            <option value="">-- Pilih Nama --</option>
            <option value="ROHADI BIN KAMALUDIN">ROHADI BIN KAMALUDIN</option>
            <option value="LUKMAN HAKIM BIN ABDULLAH">LUKMAN HAKIM BIN ABDULLAH</option>
            <option value="JAMILAH BINTI LUDIN">JAMILAH BINTI LUDIN</option>
            <option value="NOR JULIANI BINTI OTHMAN">NOR JULIANI BINTI OTHMAN</option>
            <option value="AZMEER FIRDAUS BIN ISKANDAR">AZMEER FIRDAUS BIN ISKANDAR</option>
            <option value="DG. ZAHARAH BINTI JAAFAR">DG. ZAHARAH BINTI JAAFAR</option>
            <option value="DORA BINTI SAAT">DORA BINTI SAAT</option>
            <option value="FATIMAH BINTI DOLLAH">FATIMAH BINTI DOLLAH</option>
            <option value="FILZAH HANANI BINTI MUHAMAD">FILZAH HANANI BINTI MUHAMAD</option>
            <option value="HELDA BINTI ABD MOEN">HELDA BINTI ABD MOEN</option>
            <option value="IRDAWATY BINTI MOHD BOKHARI">IRDAWATY BINTI MOHD BOKHARI</option>
            <option value="JAFNI BIN ABU BAKAR">JAFNI BIN ABU BAKAR</option>
            <option value="JUNAIDAH BINTI ABDUL LANI">JUNAIDAH BINTI ABDUL LANI</option>
            <option value="KHUSAINI BIN MD YUSOFF">KHUSAINI BIN MD YUSOFF</option>
            <option value="MAIZATUL ULLAYA BINTI YUSOP@OTHMAN">MAIZATUL ULLAYA BINTI YUSOP@OTHMAN</option>
            <option value="MARSITAH BINTI IBRAHIM">MARSITAH BINTI IBRAHIM</option>
            <option value="MOHAMMAD SAFWAN BIN NORAZAMI">MOHAMMAD SAFWAN BIN NORAZAMI</option>
            <option value="MOHD AMRAN BIN MOHD ZAWAWI">MOHD AMRAN BIN MOHD ZAWAWI</option>
            <option value="MOHD FIRDAUS BIN AB GHANI">MOHD FIRDAUS BIN AB GHANI</option>
            <option value="MUHAMAD SHUKRAN BIN ABU BAKAR">MUHAMAD SHUKRAN BIN ABU BAKAR</option>
            <option value="NAZURAH BINTI KASMIAN">NAZURAH BINTI KASMIAN</option>
            <option value="NOR DIANA BINTI AB GHANI">NOR DIANA BINTI AB GHANI</option>
            <option value="NOR ZAILIKA BINTI ZAINAL">NOR ZAILIKA BINTI ZAINAL</option>
            <option value="NURZALINA BINTI RAMLI">NURZALINA BINTI RAMLI</option>
            <option value="NORAZIAN BINTI DAUT">NORAZIAN BINTI DAUT</option>
            <option value="NORFILAH BINTI SABUDIN">NORFILAH BINTI SABUDIN</option>
            <option value="NORHAYATI BINTI SHARIF HASSAN">NORHAYATI BINTI SHARIF HASSAN</option>
            <option value="NORLAILA BINTI MOHAMED AMIN">NORLAILA BINTI MOHAMED AMIN</option>
            <option value="NURUL HAFIZAH BINTI AHMAD">NURUL HAFIZAH BINTI AHMAD</option>
            <option value="NURUL SYAZWANI BINTI ABIDIN">NURUL SYAZWANI BINTI ABIDIN</option>
            <option value="RAWAIDA BINTI MOHD BAHARIN">RAWAIDA BINTI MOHD BAHARIN</option>
            <option value="ROHANA BINTI ESA">ROHANA BINTI ESA</option>
            <option value="ROZIHAN BINTI MOHD AKIL">ROZIHAN BINTI MOHD AKIL</option>
            <option value="SHUHAIDA BINTI IBRAHIM">SHUHAIDA BINTI IBRAHIM</option>
            <option value="SITI SAPINAH BINTI AWANG">SITI SAPINAH BINTI AWANG</option>
            <option value="SITI ZANARIAH BT MOHAMED">SITI ZANARIAH BT MOHAMED</option>
            <option value="SHARIFAH HALIMATUN SYAKDIAH BINTI SYED ABDULLAH">SHARIFAH HALIMATUN SYAKDIAH BINTI SYED ABDULLAH</option>
            <option value="T.YUSNOR BIN T. YUSOF">T.YUSNOR BIN T. YUSOF</option>
            <option value="WAN KAMARUL FARIZA BT WAN KAMARUZAMAN">WAN KAMARUL FARIZA BT WAN KAMARUZAMAN</option>
            <option value="YUSRA NABILAH BINTI YUSOFF">YUSRA NABILAH BINTI YUSOFF</option>
            <option value="ZANOORFADILLAH BT ISMAIL">ZANOORFADILLAH BT ISMAIL</option>
            <option value="ZUBAIDAH BINTI ABD RAHMAN">ZUBAIDAH BINTI ABD RAHMAN</option>
            <option value="ZULAZHA BIN AB KADIR">ZULAZHA BIN AB KADIR</option>
        </select>

        <label>TARIKH PDPC</label>
        <input type="date" id="tarikh" onchange="updateView()" required>

        <label>LOKASI</label>
        <select id="bilik" onchange="updateView()" required>
            <option value="">-- Pilih Bilik --</option>
            <option value="Makmal Komputer">Makmal Komputer</option>
            <option value="Pusat Sumber">Pusat Sumber (PSS)</option>
            <option value="Studio CliPS Channel">Studio CliPS Channel</option>
        </select>

        <label>PILIH SLOT WAKTU (MAKS 3)</label>
        <div id="slotGrid" class="slot-grid"></div>

        <label>TUJUAN / KELAS</label>
        <input type="text" id="tujuan" placeholder="Cth: 5 Arif - PdPc Sains" required>

        <button type="submit" id="btn">HANTAR TEMPAHAN</button>
    </form>
</div>

<script>
    let db = [];
    const masa = { 1:"07:35", 2:"08:05", 3:"08:35", 4:"09:05", 5:"09:35", 6:"10:35", 7:"11:05", 8:"11:35", 9:"12:05", 10:"12:35", 11:"01:05", 12:"01:35" };
    
    // Data NILAM dari Jadual Cikgu
    const dataBM = { 'Monday':{5:'3A',6:'3A',7:'1A',8:'1A',10:'4A',11:'4A'}, 'Tuesday':{1:'6E',2:'6E',6:'4K',7:'4K',9:'6K',10:'6K',11:'6A',12:'6A'}, 'Wednesday':{1:'4E',2:'4E',3:'2A',4:'2A',5:'3K',6:'3K',7:'5A',8:'5A',9:'1E',10:'1E'}, 'Thursday':{1:'2E',2:'2E',5:'1K',6:'1K',10:'5E',11:'5E'}, 'Friday':{3:'2K',4:'2K',5:'3E',6:'3E',7:'5K',8:'5K'} };
    const dataBI = { 'Monday':{4:'5K',5:'5K',8:'2E',9:'2E',10:'2A',11:'2A'}, 'Tuesday':{2:'4K',3:'4K',5:'1A',6:'1A',7:'6K',8:'6K',10:'3E',11:'3E'}, 'Wednesday':{4:'5A',5:'5A',6:'4E',7:'4E',9:'3K',10:'3K'}, 'Thursday':{3:'4A',4:'4A',5:'3A',6:'3A',7:'5E',8:'5E',9:'1K',10:'1K'}, 'Friday':{2:'6A',3:'6A',4:'6E',5:'6E',6:'2K',7:'2K',8:'1E',9:'1E'} };

    window.onload = () => { google.script.run.withSuccessHandler(res => { db = res; }).readData(); };

    function updateView() {
        const tkh = document.getElementById('tarikh').value;
        const blk = document.getElementById('bilik').value;
        const grid = document.getElementById('slotGrid');
        grid.innerHTML = "";
        if(!tkh) return;

        const d = new Date(tkh);
        const hari = d.toLocaleDateString('en-US', { weekday: 'long' });
        const mula = new Date("2026-01-12");
        const minggu = Math.floor((d - mula) / (7 * 24 * 60 * 60 * 1000)) + 1;
        const isGanjil = minggu % 2 !== 0;

        document.getElementById('infoBar').innerText = `MINGGU ${minggu} (${hari.toUpperCase()})`;
        if(!blk) return;

        let booked = db.filter(r => {
          let rDate = new Date(r.tarikh);
          return rDate.toISOString().split('T')[0] === tkh && r.bilik === blk;
        }).flatMap(r => r.waktu.split(", "));

        for(let i=1; i<=12; i++) {
            let tajuk = `Waktu ${i}`;
            let isFull = booked.includes(tajuk);
            let tagHTML = "";

            // LOGIK NILAM MENGIKUT BILIK & MINGGU
            if(blk === "Makmal Komputer") {
                if(isGanjil && dataBM[hari]?.[i]) tagHTML = `<div class="nilam-tag tag-bm">NILAM BM<br>(${dataBM[hari][i]})</div>`;
                else if(!isGanjil && dataBI[hari]?.[i]) tagHTML = `<div class="nilam-tag tag-bi">NILAM BI<br>(${dataBI[hari][i]})</div>`;
            } else if(blk === "Pusat Sumber") {
                if(isGanjil && dataBI[hari]?.[i]) tagHTML = `<div class="nilam-tag tag-bi">NILAM BI<br>(${dataBI[hari][i]})</div>`;
                else if(!isGanjil && dataBM[hari]?.[i]) tagHTML = `<div class="nilam-tag tag-bm">NILAM BM<br>(${dataBM[hari][i]})</div>`;
            }

            const card = document.createElement('div');
            card.className = `slot-card ${isFull ? 'booked' : ''}`;
            card.innerHTML = `<span class="masa-txt">${masa[i]}</span><span class="waktu-txt">${tajuk}</span>${tagHTML}`;
            
            if(isFull) {
                card.innerHTML += `<b style="color:#e11d48; font-size:0.6rem; margin-top:4px;">DITEMPAH</b>`;
            } else {
                card.onclick = () => {
                  if(!card.classList.contains('selected') && document.querySelectorAll('.selected').length >= 3) return alert("Maksimum 3 slot!");
                  card.classList.toggle('selected');
                };
            }
            grid.appendChild(card);
        }
    }

    function hantar(e) {
        e.preventDefault();
        const sel = Array.from(document.querySelectorAll('.selected .waktu-txt')).map(el => el.innerText);
        if(sel.length === 0) return alert("Pilih slot!");
        
        const btn = document.getElementById('btn');
        btn.disabled = true; btn.innerText = "Menghantar...";

        const payload = {
            nama: document.getElementById('nama').value,
            tarikh: document.getElementById('tarikh').value,
            bilik: document.getElementById('bilik').value,
            waktu: sel.join(", "),
            tujuan: document.getElementById('tujuan').value
        };

        google.script.run.withSuccessHandler(() => {
            alert("Tempahan Berjaya!");
            location.reload();
        }).doPost(payload);
    }
</script>
</body>
</html>
